<!DOCTYPE html>
<html>
  <head>
    <title>{{head.title}}</title>
    {{{head.meta_tags}}}
    {{{head.config}}}

    <link href="{{head.favicon}}" rel="shortcut icon">

    {{{checkout.checkout_head}}}
    {{{stylesheet '/assets/css/optimized-checkout.css'}}}
    {{{stylesheet '/assets/css/theme.css'}}}
    {{getFontsCollection}}

   
      <style rel="stylesheet" type="text/css">
      .checkoutHeader-logo{
        max-width: 350px;
      }

      .feedback__link{
        display: block;
        padding: 20px 0;
        text-decoration: underline;
      }

      .klaviyo-form-MnvYmV{
        position: fixed;
        width: 500px;
        top: 50%;
        z-index: 9999;
        left: 50%;
        margin-top: -100px;
        margin-left: -250px;
        height: 200px;
        background-color: #fff;
        border: 1px solid #ddd;
        box-shadow: 0px 1px 50px 7px rgba(0, 0, 0, 0.34);
        border-radius: 5px;
        display: none;
        flex: 1;
        justify-content: center;
        align-items: center;
        align-content: center;
      }
      
      .ResetElements__Div-sc-8e6zl9-0{
        align-content: center !important;
        align-items: center !important;
      }

      .ResetElements__Input-sc-8e6zl9-6{
        height: 32px !important;
        width: 100% !important;
      }

      .unsubscribe__closeModal{
        order: 1;
        color: #222;
        font-size: 1.6rem;
        line-height: 1;
        display: block;
        position: absolute;
        top: 0;
        right: 0;
        padding: 10px 20px;
      }
    </style>

    <script async src="//static.klaviyo.com/onsite/js/klaviyo.js?company_id=JL4kkS"></script>
    <script src="//cdn.searchspring.net/intellisuggest/is.min.js"></script>
    <script src="{{cdn '/assets/js/modernizr.js'}}"></script>
    <script src="{{cdn '/assets/js/bundle.js'}}"></script>

    {{> components/header/customizations/heap}}

    <script type="text/javascript">
      window.language = {{{langJson 'optimized_checkout'}}};
    </script>

    {{{head.scripts}}}
  </head>

  <body>
    <header class="checkoutHeader optimizedCheckout-header">
      <div class="checkoutHeader-content">
        <h1 class="is-srOnly">{{lang 'checkout.title'}}</h1>
        <h2 class="checkoutHeader-heading">
          <a class="checkoutHeader-link" href="{{urls.home}}">
            {{#if checkout.header_image}}
                <img class="checkoutHeader-logo" src="https://authenteak.s3.us-east-2.amazonaws.com/logo/Authenteak-logo.svg" alt="{{settings.store_logo.title}}">

              <!-- <img class="checkoutHeader-logo" src="{{cdn 'assets/img/authenteak-logo.svg?imbypass=on'}}" alt="{{settings.store_logo.title}}"> -->
              <!-- <img alt="{{settings.store_logo.title}}" class="checkoutHeader-logo" id="logoImage" src="{{ checkout.header_image }}"/> -->
            {{else}}
              <span class="header-logo-text">{{settings.store_logo.title}}</span>
            {{/if}}
          </a>
        </h2>
      </div>
    </header>

    {{{checkout.order_confirmation_content}}}

    <div class="toolTip__cntr toolTip__cntr--small toolTip__cntr--hide" id="feedBackModal">
      <button class="toolTip__closeBtn toolTip__closeBtn--whiteBack" data-close-modal rel="#feedBackModal">
        <svg class="toolTip__closeIcon" enable-background="new 0 0 24 24" version="1.1" viewBox="0 0 24 24" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
          <path d="M13.4 12l5.3-5.3c0.4-0.4 0.4-1 0-1.4s-1-0.4-1.4 0l-5.3 5.3-5.3-5.3c-0.4-0.4-1-0.4-1.4 0s-0.4 1 0 1.4l5.3 5.3-5.3 5.3c-0.4 0.4-0.4 1 0 1.4 0.2 0.2 0.4 0.3 0.7 0.3s0.5-0.1 0.7-0.3l5.3-5.3 5.3 5.3c0.2 0.2 0.5 0.3 0.7 0.3s0.5-0.1 0.7-0.3c0.4-0.4 0.4-1 0-1.4l-5.3-5.3z"></path>
        </svg>
      </button>

      <iframe src="https://www.surveymonkey.com/r/ZB9WGC8" style="width: 100%; height: 500px;"></iframe>
    </div>


    {{{footer.scripts}}}

    <script>
      (function(){
        const modal = {
          openGeneric: function(e){
            let $this = $(this);
            $($this.attr("rel")).toggleClass("hide");
            e.preventDefault();
          },

          checkClickToCloseModal: function(e){
              if ( !$(e.target).closest('#feedBackModal').length && !$(e.target).closest("[data-open-modal]").length ){
                $("[data-close-modal]", document.body).click();
              }
            
          },

          checkKeyToCloseModal: function(e){
              if( e.which === 27 ){
                $("[data-close-modal]", document.body).click();
              }
          }

        };

        $(document.body)
          .on("click", modal.checkClickToCloseModal)
          .on("keydown", modal.checkKeyToCloseModal)
          .on("click", "[data-open-modal]", modal.openGeneric)
          .on("click", "[data-close-modal]", modal.openGeneric)
      }())

      TEAK.Checkout = {

        // clear cart from local storage
        clearStorage: function(item){
          window.localStorage.removeItem(item);
          return this;
        },

        /* 
          Injects the unsubscribe form into the pages
          - Note: this is a work around because Bolt doesnt support Klaviyo  email signup from it's UI
        */
        buildUI: function(){
          try{
            let confirmSection = document.getElementById("micro-app-ng-checkout");
            
            if(confirmSection){
              confirmSection.querySelector(".orderConfirmation-section");

              let klaviyoForm = document.createElement('div');
              klaviyoForm.setAttribute("class", "klaviyo-form-MnvYmV");

              let text = document.createElement('p');
              text.setAttribute("class", "unsubscribe__text");
              text.innerHTML = "It's official, you're an AuthenTEAK Insider! You'll be the first to know about promotions, events & new arrivals. If you wish to unsubscribe, <a href='' onclick='TEAK.Checkout.unsubscribePopupOpen(event);'>let us know</a>.";

              let closeBtn = document.createElement('a');
              closeBtn.setAttribute("class", "unsubscribe__closeModal");
              closeBtn.setAttribute("onclick", "TEAK.Checkout.unsubscribePopupClose(event)");
              closeBtn.innerHTML = "&times;";
              klaviyoForm.appendChild(closeBtn);

              confirmSection.appendChild(text);
              confirmSection.appendChild(klaviyoForm);

              TEAK.Checkout.hidePayByCheck();
            }
            

          }catch(err){
            console.log(err)
          }

          return this;
        },

        /* Open Modal */
        unsubscribePopupOpen: function(event){
          event.preventDefault();
          document.querySelector(".klaviyo-form-MnvYmV").style.display = "flex";
          return this;
        },

        /* Close Modal */
        unsubscribePopupClose: function(event){
          event.preventDefault();
          document.querySelector(".klaviyo-form-MnvYmV").style.display = "none";
          return this;
        },

        // hide pay by check field
        hidePayByCheck: function(){
          let tags = document.getElementsByClassName("orderConfirmation-section");

          for (let i = 0; i < tags.length; i++) {
            let txt = tags[i].innerText || tags[i].innerHTML;
            if (txt.includes("pay by check")) {
              tags[i].style.display = 'none';
            }
          }
        },

        insertSurveyLink: function(){
          let survey = '<a href="#feedBackModal" class="feedback__link" rel="#feedBackModal" data-open-modal>Provide Website Feedback &rsaquo;</a>';
          $(survey).appendTo(".continueButtonContainer");
        },

        heap: function(){
          var storedCart = TEAK.Utils.getStoredCart();

          if(typeof storedCart !== "undefined" && typeof storedCart.lineItems !== "undefined"){
              TEAK.thirdParty.heap.init({
                method: 'identify'{{#if customer}},
                id: '{{customer.id}}.authenteak.com'{{/if}}
              });
              
              TEAK.thirdParty.heap.init({
                method: 'track',
                event: 'order_completed',
                location: 'OrderConfirmation',
                order_id: storedCart.id,
                subtotal: storedCart.baseAmount,
                total: storedCart.cartAmount,
                shipping: "",
                discount: storedCart.discountAmount,
                discount_code: storedCart.discounts.length ? storedCart.discounts[0].id : ""
              });

            }
            
        },
        

        // third party intelliSuggest tracking
        intelliSuggest: function(){
          try{
            IntelliSuggest.init({
              siteId: TEAK.thirdParty.IntelliSuggest.siteId,
            });
              
            // Loop through products in cart
            TEAK.thirdParty.IntelliSuggest.haveItemArray.forEach( function(element){
              IntelliSuggest.haveItem(element);
            });
        
            IntelliSuggest.inSale({
                orderId: TEAK.thirdParty.IntelliSuggest.cartId,
                transactionId: TEAK.thirdParty.IntelliSuggest.cartId,
                total: TEAK.thirdParty.IntelliSuggest.cartAmount,
                city: "{{order.shipping_address.city}}",
                state: "{{order.shipping_address.state}}",
                country: "US"
            });

            TEAK.Checkout.heap();
            
          }catch(err){
            console.log(err)
          }
         
          $(window).on("load", TEAK.Checkout.insertSurveyLink);

          return this;
        }

      };

      setTimeout(TEAK.Checkout.buildUI, 500);

      // 3rd Party IntelliSuggest tracking
      document.addEventListener('DOMContentLoaded', TEAK.Checkout.intelliSuggest);

      // clear out stored cart data
      TEAK.Checkout.clearStorage('cartData');


      </script>


</body>
</html>
